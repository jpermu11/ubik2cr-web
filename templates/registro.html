<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Publicar Negocio | Ubik2CR</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Leaflet (mapa con pin) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body { background:#f5f7fa; }

    .topbar{
      background: linear-gradient(90deg,#0b4fa3,#38b24d);
      color:#fff;
    }
    .brand img{ height:56px; }
    .brand span{ font-weight:800; letter-spacing:.2px; }

    .hero-mini{
      background: linear-gradient(135deg, rgba(11,79,163,.12), rgba(56,178,77,.12));
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 18px;
      padding: 18px;
    }

    .cardx{
      border:none; border-radius:18px;
      box-shadow:0 10px 25px rgba(0,0,0,.08);
      overflow:hidden;
    }
    .cardx-header{
      background: rgba(11,79,163,.08);
      border-bottom:1px solid rgba(0,0,0,.06);
    }

    #map{
      height: 360px !important;
      min-height: 360px;
      width: 100%;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.10);
      background-color: #f5f5f5;
      position: relative;
    }
    
    #map:empty::before {
      content: "Cargando mapa...";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #666;
      font-size: 14px;
    }

    .hint{
      font-size:.92rem;
      color:#6c757d;
    }

    .btn-primary{
      background:#0b4fa3;
      border:none;
      font-weight:800;
    }
    .btn-primary:hover{ filter:brightness(.95); }

    .btn-success{
      background:#38b24d;
      border:none;
      font-weight:800;
    }
    .btn-success:hover{ filter:brightness(.95); }

    .required::after{
      content:" *";
      color:#dc3545;
      font-weight:800;
    }
  </style>
</head>

<body>

<!-- HEADER -->
<nav class="navbar topbar">
  <div class="container d-flex align-items-center justify-content-between py-2">
    <a class="navbar-brand brand d-flex align-items-center gap-2 text-white text-decoration-none" href="/">
      <img src="{{ url_for('static', filename='uploads/logo.png') }}" alt="Ubik2CR">
      <span class="fs-4">Ubik2CR</span>
    </a>

    <div class="d-flex gap-2">
      <a href="/" class="btn btn-light fw-bold">
        <i class="fa-solid fa-house me-1"></i> Inicio
      </a>
      <a href="/mapa" class="btn btn-outline-light">
        <i class="fa-solid fa-map-location-dot me-1"></i> Mapa
      </a>
    </div>
  </div>
</nav>

<div class="container my-4">

  <div class="hero-mini mb-3 d-flex align-items-center justify-content-between flex-wrap gap-2">
    <div>
      <h2 class="fw-bold mb-1">üìå Publicar un Negocio o Lugar</h2>
      <div class="hint">
        No necesit√°s saber coordenadas: <b>toc√° el mapa</b> y el pin se coloca solo ‚úÖ
      </div>
    </div>
    <img src="{{ url_for('static', filename='uploads/logo.png') }}" alt="Ubik2CR" style="height:70px;">
  </div>

  <div class="cardx">
    <div class="cardx-header p-3">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="fw-bold">
          <i class="fa-solid fa-circle-plus me-2"></i> Formulario de publicaci√≥n
        </div>
        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#guiaModal" style="font-weight: 600;">
          <i class="fas fa-question-circle me-1"></i> Ver gu√≠a de ayuda
        </button>
      </div>
      <div class="hint mt-2">Tu negocio queda <b>pendiente</b> hasta ser aprobado por el administrador.</div>
    </div>

    <div class="p-4">
      <form method="POST" enctype="multipart/form-data" id="formNegocio">

        <div class="row g-3">

          <div class="col-md-8">
            <label class="form-label fw-bold required">Nombre del negocio / lugar</label>
            <input type="text" name="nombre" class="form-control form-control-lg" required placeholder="Ej: Soda Don Pepe, Iglesia San Pedro...">
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold required">Categor√≠a</label>
            <select name="categoria" class="form-select form-select-lg" required>
              
              <optgroup label="üçΩÔ∏è Comida y Bebidas">
                <option value="Sodas y Rest.">üç¥ Sodas y Rest.</option>
                <option value="Comida R√°pida">üçï Comida R√°pida</option>
                <option value="Cafeter√≠as">‚òï Cafeter√≠as</option>
                <option value="Bares y Licores">üç∫ Bares y Licores</option>
                <option value="Helader√≠as">üç¶ Helader√≠as</option>
                <option value="Restaurante">üçî Restaurantes</option>
              </optgroup>
              
              <optgroup label="üõí Alimentos">
                <option value="Verdurer√≠as">ü•¨ Verdurer√≠as</option>
                <option value="Carnicer√≠as">ü•© Carnicer√≠as</option>
                <option value="Panader√≠as">ü•ê Panader√≠as</option>
                <option value="Super y Pulpes">üõí Super y Pulpes</option>
              </optgroup>
              
              <optgroup label="üè• Salud">
                <option value="Farmacias">üíä Farmacias</option>
                <option value="Cl√≠nicas y Dr.">ü©∫ Cl√≠nicas y Dr.</option>
                <option value="Dentistas">ü¶∑ Dentistas</option>
                <option value="Laboratorios">üß™ Laboratorios</option>
                <option value="Veterinarias">üêæ Veterinarias</option>
                <option value="√ìpticas">üëì √ìpticas</option>
                <option value="CCSS">üè• CCSS / Cl√≠nica / Eb√°is</option>
              </optgroup>
              
              <optgroup label="üíÖ Belleza y Fitness">
                <option value="Gimnasios">üí™ Gimnasios</option>
                <option value="Spas y Masajes">üßò Spas y Masajes</option>
                <option value="Belleza y Barber√≠a">‚úÇÔ∏è Belleza y Barber√≠a</option>
              </optgroup>
              
              <optgroup label="üëï Ropa y Tecnolog√≠a">
                <option value="Ropa y Calzado">üëó Ropa y Calzado</option>
                <option value="Tecnolog√≠a y Cel.">üì± Tecnolog√≠a y Cel.</option>
                <option value="Reparaciones Tech">üíª Reparaciones Tech</option>
              </optgroup>
              
              <optgroup label="üîß Construcci√≥n y Automotriz">
                <option value="Ferreter√≠as">üî® Ferreter√≠as</option>
                <option value="Materiales Construcci√≥n">üß± Materiales Construcci√≥n</option>
                <option value="Mec√°nica y Llantas">üîß Mec√°nica y Llantas</option>
                <option value="Transporte">üöï Transporte</option>
                <option value="Gasolineras">‚õΩ Gasolineras</option>
                <option value="Automotriz">üöó Automotriz</option>
              </optgroup>
              
              <optgroup label="üìö Educaci√≥n y Cultura">
                <option value="Librer√≠as y Bazar">üìñ Librer√≠as y Bazar</option>
                <option value="Escuelas">üè´ Escuelas</option>
                <option value="Bibliotecas">üìö Bibliotecas</option>
                <option value="Academias">üéì Academias</option>
                <option value="Educacion">üéì Educaci√≥n</option>
              </optgroup>
              
              <optgroup label="üè® Turismo y Entretenimiento">
                <option value="Hoteles y Hospedaje">üè® Hoteles y Hospedaje</option>
                <option value="Parques">üå≥ Parques</option>
                <option value="Plazas">üèûÔ∏è Plazas</option>
                <option value="Polideportivo">üèüÔ∏è Polideportivos</option>
                <option value="Cines y Entretenimiento">üé¨ Cines y Entretenimiento</option>
                <option value="Turismo">üó∫Ô∏è Turismo</option>
              </optgroup>
              
              <optgroup label="üí∞ Finanzas">
                <option value="Bancos">üè¶ Bancos</option>
                <option value="Cooperativas">üíµ Cooperativas</option>
              </optgroup>
              
              <optgroup label="üèõÔ∏è Servicios P√∫blicos">
                <option value="Cruz Roja">üöë Cruz Roja</option>
                <option value="Bomberos">üöí Bomberos</option>
                <option value="Polic√≠a">üöì Polic√≠a</option>
                <option value="Municipalidad">üèõÔ∏è Municipalidad</option>
                <option value="Iglesia">‚õ™ Iglesias</option>
                <option value="Instituciones P√∫blicas">üè¢ Instituciones P√∫blicas</option>
                <option value="Edificio Gubernamental">üè¢ Edificio Gubernamental</option>
              </optgroup>
              
              <optgroup label="üíº Servicios Profesionales">
                <option value="Servicios Pro">üíº Servicios Pro</option>
                <option value="Consultor√≠a">üìä Consultor√≠a</option>
                <option value="Abogados">‚öñÔ∏è Abogados</option>
                <option value="Contables">üìã Contables</option>
                <option value="Salones de Eventos">üéâ Salones de Eventos</option>
                <option value="Mudanzas y Transporte">üöö Mudanzas y Transporte</option>
                <option value="Plomer√≠a y Electricidad">‚ö° Plomer√≠a y Electricidad</option>
                <option value="Jardiner√≠a">üå± Jardiner√≠a</option>
                <option value="Mascotas y Suministros">üêï Mascotas y Suministros</option>
                <option value="Servicios">üß∞ Servicios</option>
              </optgroup>
              
              <optgroup label="üè™ Otros">
                <option value="Comercio">üè™ Comercios</option>
                <option value="Otros">‚ú® Otros</option>
              </optgroup>

            </select>
          </div>

          <!-- Ubicaci√≥n geogr√°fica de Costa Rica -->
          <div class="col-md-4">
            <label class="form-label fw-bold required">Provincia</label>
            <select name="provincia" id="provincia" class="form-select form-control-lg" required onchange="cargarCantones()">
              <option value="">Seleccionar provincia</option>
              <option value="San Jos√©">San Jos√©</option>
              <option value="Alajuela">Alajuela</option>
              <option value="Cartago">Cartago</option>
              <option value="Heredia">Heredia</option>
              <option value="Guanacaste">Guanacaste</option>
              <option value="Puntarenas">Puntarenas</option>
              <option value="Lim√≥n">Lim√≥n</option>
            </select>
            <div class="hint mt-1">Seleccion√° la provincia donde est√° tu negocio</div>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold required">Cant√≥n</label>
            <select name="canton" id="canton" class="form-select form-control-lg" required onchange="cargarDistritos()" disabled>
              <option value="">Primero seleccion√° una provincia</option>
            </select>
            <div class="hint mt-1">Seleccion√° el cant√≥n</div>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold required">Distrito</label>
            <select name="distrito" id="distrito" class="form-select form-control-lg" required disabled>
              <option value="">Primero seleccion√° un cant√≥n</option>
            </select>
            <div class="hint mt-1">Seleccion√° el distrito</div>
          </div>

          <div class="col-md-12">
            <label class="form-label fw-bold required">Ubicaci√≥n (texto)</label>
            <input type="text" name="ubicacion" class="form-control form-control-lg" required
                   placeholder="Ej: 200m norte de la iglesia, San Juan de Po√°s">
            <div class="hint mt-1">Direcci√≥n espec√≠fica que ver√° la gente (aunque el pin sea exacto en el mapa)</div>
          </div>

          <div class="col-md-5">
            <label class="form-label fw-bold">Link de Google Maps (opcional)</label>
            <input type="url" name="maps_url" class="form-control form-control-lg" placeholder="https://maps.app.goo.gl/...">
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Tel√©fono (opcional)</label>
            <input type="text" name="telefono" class="form-control form-control-lg" placeholder="Ej: 2448-5858">
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">WhatsApp (opcional)</label>
            <input type="text" name="whatsapp" class="form-control form-control-lg" placeholder="Ej: +506 8888-8888">
          </div>

          <div class="col-12">
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="abierto_24h" name="abierto_24h" value="1" onchange="toggleHorarios()">
              <label class="form-check-label fw-bold" for="abierto_24h">Abierto 24 horas</label>
            </div>
          </div>

          <div class="col-12" id="horarios-container">
            <label class="form-label fw-bold mb-3">Horario por d√≠a (opcional)</label>
            <div class="row g-2">
              {% set dias = [
                ('lunes', 'Lunes'),
                ('martes', 'Martes'),
                ('miercoles', 'Mi√©rcoles'),
                ('jueves', 'Jueves'),
                ('viernes', 'Viernes'),
                ('sabado', 'S√°bado'),
                ('domingo', 'Domingo')
              ] %}
              {% for dia_key, dia_nombre in dias %}
              <div class="col-md-6 col-lg-4">
                <div class="card p-2" style="border: 1px solid #ddd; border-radius: 8px;">
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="horario_{{ dia_key }}_abierto" name="horario_{{ dia_key }}_abierto" value="1" onchange="toggleDia('{{ dia_key }}')">
                    <label class="form-check-label fw-bold" for="horario_{{ dia_key }}_abierto">{{ dia_nombre }}</label>
                  </div>
                  <div id="horario_{{ dia_key }}_times" style="display:none;">
                    <div class="row g-1">
                      <div class="col-6">
                        <input type="time" class="form-control form-control-sm" name="horario_{{ dia_key }}_apertura" placeholder="Apertura">
                      </div>
                      <div class="col-6">
                        <input type="time" class="form-control form-control-sm" name="horario_{{ dia_key }}_cierre" placeholder="Cierre">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            <div class="hint mt-2">Marc√° los d√≠as que est√° abierto y especific√° las horas de apertura y cierre.</div>
          </div>

          <div class="col-12">
            <label class="form-label fw-bold">
              <i class="fas fa-images me-2" style="color: var(--brand-blue);"></i>
              Fotos del negocio <small class="text-muted">(Opcional - m√°ximo 10 fotos)</small>
            </label>
            <input type="file" name="fotos" id="fotos" class="form-control form-control-lg" accept="image/*" multiple>
            <div class="hint mt-2">
              <i class="fas fa-info-circle me-1"></i>
              Pod√©s subir hasta 10 fotos de tu negocio. Presion√° Ctrl (o Cmd en Mac) y seleccion√° m√∫ltiples archivos, o seleccion√° una por una.
              La primera foto ser√° la imagen principal. Si no sub√≠s fotos, se usar√° el logo por defecto.
            </div>
            <div id="preview-fotos" class="mt-3" style="display: none;">
              <div class="d-flex flex-wrap gap-2" id="preview-container"></div>
            </div>
          </div>

          <div class="col-12">
            <label class="form-label fw-bold required">Descripci√≥n</label>
            <textarea name="descripcion" rows="4" class="form-control form-control-lg" required
                      placeholder="Describe lo que ofrece, horarios, servicios, etc."></textarea>
          </div>

          <div class="col-12">
            <label class="form-label fw-bold">
              <i class="fas fa-tags me-2" style="color: var(--brand-blue);"></i>
              Productos / Servicios que ofrec√©s (Tags) <small class="text-muted">(Opcional)</small>
            </label>
            <input type="text" name="productos_tags" id="productos_tags" class="form-control form-control-lg"
                   placeholder="Ej: martillo, clavos, pintura, herramientas, servicio de instalaci√≥n..."
                   data-role="tagsinput">
            <div class="hint mt-2">
              <i class="fas fa-info-circle me-1"></i>
              Agreg√° productos o servicios que vend√©s (separados por comas). Ej: "martillo, clavos, pintura" o "hamburguesa, papas fritas, refrescos".
              Esto ayudar√° a que los clientes te encuentren m√°s f√°cilmente cuando busquen estos productos.
            </div>
            <div class="mt-2" id="tags-display" style="display: none;">
              <div class="d-flex flex-wrap gap-2" id="tags-container"></div>
            </div>
          </div>

        </div>

        <hr class="my-4">

        <!-- MAPA -->
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="fw-bold">
            <i class="fa-solid fa-map-pin me-2"></i> Marc√° la ubicaci√≥n exacta
          </div>
          <div class="hint">Toc√° el mapa para colocar el pin ‚úÖ</div>
        </div>

        <div id="map"></div>

        <!-- hidden lat/long (se llenan con el pin) -->
        <input type="hidden" id="latitud" name="latitud" value="">
        <input type="hidden" id="longitud" name="longitud" value="">

        <div class="hint mt-2">
          Si no marc√°s el pin, se puede publicar igual, pero es mejor marcarlo para salir bien en el mapa.
        </div>

        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-success btn-lg px-4">
            <i class="fa-solid fa-paper-plane me-2"></i> Publicar
          </button>
          <a href="/" class="btn btn-outline-secondary btn-lg px-4">
            Cancelar
          </a>
        </div>

      </form>
    </div>
  </div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // Fix para iconos de Leaflet (necesario para que funcionen los marcadores)
  delete L.Icon.Default.prototype._getIconUrl;
  L.Icon.Default.mergeOptions({
    iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
  });

  // Centro por defecto (Costa Rica)
  const defaultLat = 9.9281;
  const defaultLng = -84.0907;

  const latInput = document.getElementById("latitud");
  const lngInput = document.getElementById("longitud");

  if (!latInput || !lngInput) {
    console.error("No se encontraron los inputs de latitud/longitud");
  }

  // Inicializar mapa solo cuando el DOM est√© listo y el elemento sea visible
  let map = null;
  let marker = null;

  function initMap() {
    const mapElement = document.getElementById('map');
    if (!mapElement) {
      console.error("No se encontr√≥ el elemento #map");
      return;
    }

    // Verificar que el elemento tenga dimensiones
    if (mapElement.offsetWidth === 0 || mapElement.offsetHeight === 0) {
      // Si no tiene dimensiones, intentar de nuevo despu√©s de un breve delay
      setTimeout(initMap, 100);
      return;
    }

    try {
      // Inicializar el mapa
      map = L.map('map', {
        center: [defaultLat, defaultLng],
        zoom: 12,
        zoomControl: true
      });

      // Agregar capa de tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      // Asegurar que el mapa se renderice correctamente
      setTimeout(function() {
        if (map) {
          map.invalidateSize();
        }
      }, 100);

      // Click para poner pin
      map.on('click', function(e){
        setMarker(e.latlng.lat, e.latlng.lng);
      });

      console.log("Mapa inicializado correctamente");
    } catch (error) {
      console.error("Error al inicializar el mapa:", error);
    }
  }

  function setMarker(lat, lng){
    if (!map) {
      console.error("El mapa no est√° inicializado");
      return;
    }
    if(marker) map.removeLayer(marker);
    marker = L.marker([lat, lng]).addTo(map);
    if (latInput) latInput.value = lat.toFixed(6);
    if (lngInput) lngInput.value = lng.toFixed(6);
  }

  // Inicializar el mapa cuando el DOM est√© listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initMap, 200);
    });
  } else {
    // DOM ya est√° listo
    setTimeout(initMap, 200);
  }

  // Sistema de tags/productos
  const productosTagsInput = document.getElementById('productos_tags');
  const tagsContainer = document.getElementById('tags-container');
  const tagsDisplay = document.getElementById('tags-display');
  let tagsArray = [];

  if (productosTagsInput && tagsContainer && tagsDisplay) {
    productosTagsInput.addEventListener('input', function(e) {
      const value = e.target.value.trim();
      if (value.endsWith(',') || (value.endsWith(' ') && value.length > 1)) {
        const tags = value.replace(/,\s*$/, '').split(/[,\s]+/).filter(t => t.trim() !== '').map(t => t.trim().toLowerCase());
        tags.forEach(tag => {
          if (tag && !tagsArray.includes(tag)) {
            tagsArray.push(tag);
          }
        });
        actualizarTagsDisplay();
        productosTagsInput.value = '';
      }
    });

    productosTagsInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const value = e.target.value.trim();
        if (value) {
          const tags = value.split(/[,\s]+/).filter(t => t.trim() !== '').map(t => t.trim().toLowerCase());
          tags.forEach(tag => {
            if (tag && !tagsArray.includes(tag)) {
              tagsArray.push(tag);
            }
          });
          actualizarTagsDisplay();
          productosTagsInput.value = '';
        }
      } else if (e.key === 'Backspace' && productosTagsInput.value === '' && tagsArray.length > 0) {
        tagsArray.pop();
        actualizarTagsDisplay();
      }
    });

    function actualizarTagsDisplay() {
      if (tagsArray.length === 0) {
        tagsDisplay.style.display = 'none';
        return;
      }
      
      tagsDisplay.style.display = 'block';
      tagsContainer.innerHTML = tagsArray.map((tag, index) => `
        <span class="badge bg-primary" style="font-size: 0.875rem; padding: 8px 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;" onclick="eliminarTag(${index})">
          #${tag}
          <i class="fas fa-times" style="font-size: 0.75rem;"></i>
        </span>
      `).join('');
    }

    window.eliminarTag = function(index) {
      if (tagsArray && tagsArray.length > index) {
        tagsArray.splice(index, 1);
        actualizarTagsDisplay();
      }
    };

    // Al enviar el formulario, agregar los tags como input hidden
    const form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', function(e) {
        if (tagsArray && tagsArray.length > 0) {
          let hiddenInput = document.getElementById('productos_tags_json');
          if (!hiddenInput) {
            hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.id = 'productos_tags_json';
            hiddenInput.name = 'productos_tags_json';
            this.appendChild(hiddenInput);
          }
          hiddenInput.value = JSON.stringify(tagsArray);
        }
      });
    }
  }

  // Horario vs 24h
  const chk24 = document.getElementById("abierto_24h");
  const horarioInput = document.getElementById("horario");
  function toggleHorarios() {
    const abierto24h = document.getElementById('abierto_24h');
    const container = document.getElementById('horarios-container');
    if (!abierto24h || !container) return;
    
    if (abierto24h.checked) {
      container.style.display = 'none';
      // Desmarcar todos los d√≠as
      document.querySelectorAll('[id^="horario_"][id$="_abierto"]').forEach(cb => {
        cb.checked = false;
        const diaKey = cb.id.replace('horario_', '').replace('_abierto', '');
        const timesDiv = document.getElementById(`horario_${diaKey}_times`);
        if (timesDiv) {
          timesDiv.style.display = 'none';
        }
      });
    } else {
      container.style.display = 'block';
    }
  }

  function toggleDia(diaKey) {
    const checkbox = document.getElementById(`horario_${diaKey}_abierto`);
    const timesDiv = document.getElementById(`horario_${diaKey}_times`);
    if (checkbox && timesDiv) {
      if (checkbox.checked) {
        timesDiv.style.display = 'block';
      } else {
        timesDiv.style.display = 'none';
        // Limpiar los campos de hora
        const apertura = timesDiv.querySelector(`input[name="horario_${diaKey}_apertura"]`);
        const cierre = timesDiv.querySelector(`input[name="horario_${diaKey}_cierre"]`);
        if (apertura) apertura.value = '';
        if (cierre) cierre.value = '';
      }
    }
  }

  // Inicializar
  const chk24 = document.getElementById('abierto_24h');
  if (chk24) {
    chk24.addEventListener('change', toggleHorarios);
    toggleHorarios(); // Ejecutar al cargar
  }

  // Previsualizar m√∫ltiples fotos
  const fotosInput = document.getElementById('fotos');
  const previewContainer = document.getElementById('preview-container');
  const previewDiv = document.getElementById('preview-fotos');
  
  if (fotosInput && previewContainer && previewDiv) {
    fotosInput.addEventListener('change', function(e) {
      const files = Array.from(e.target.files);
      
      // Limitar a 10 fotos
      if (files.length > 10) {
        alert('Solo pod√©s subir un m√°ximo de 10 fotos. Se tomar√°n las primeras 10.');
        files.splice(10);
      }
      
      if (files.length === 0) {
        previewDiv.style.display = 'none';
        previewContainer.innerHTML = '';
        return;
      }
      
      previewDiv.style.display = 'block';
      previewContainer.innerHTML = '';
      
      files.forEach((file, index) => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const imgDiv = document.createElement('div');
            imgDiv.className = 'position-relative';
            imgDiv.style.cssText = 'width: 120px; height: 120px; border-radius: 8px; overflow: hidden; border: 2px solid #dee2e6;';
            imgDiv.innerHTML = `
              <img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;" alt="Preview ${index + 1}">
              <span style="position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${index + 1}</span>
            `;
            previewContainer.appendChild(imgDiv);
          };
          reader.readAsDataURL(file);
        }
      });
      
      // Actualizar el input para limitar a 10 archivos
      const dt = new DataTransfer();
      files.slice(0, 10).forEach(file => dt.items.add(file));
      fotosInput.files = dt.files;
    });
  }

  // Validar cantidad de fotos al enviar
  const formNegocio = document.getElementById('formNegocio');
  if (formNegocio) {
    formNegocio.addEventListener('submit', function(e) {
      const fotosInput = document.getElementById('fotos');
      if (fotosInput && fotosInput.files.length > 10) {
        e.preventDefault();
        alert('Solo pod√©s subir un m√°ximo de 10 fotos. Por favor, seleccion√° menos fotos.');
        return false;
      }
    });
  }
</script>

<!-- Modal de Gu√≠a -->
<div class="modal fade" id="guiaModal" tabindex="-1" aria-labelledby="guiaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content" style="border-radius: 18px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
      <div class="modal-header" style="background: linear-gradient(90deg, #0b4fa3, #38b24d); color: white; border-radius: 18px 18px 0 0;">
        <h5 class="modal-title fw-bold" id="guiaModalLabel">
          <i class="fas fa-question-circle me-2"></i>Gu√≠a para Publicar tu Negocio
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding: 32px;">
        <div class="mb-4">
          <h5 class="fw-bold mb-3" style="color: #0b4fa3;">
            <i class="fas fa-info-circle me-2"></i>¬øC√≥mo completar el formulario?
          </h5>
          <p class="text-muted mb-4">Segu√≠ estos pasos para publicar tu negocio correctamente:</p>
        </div>

        <div class="accordion" id="guiaAccordion">
          <!-- Informaci√≥n B√°sica -->
          <div class="accordion-item mb-3" style="border-radius: 12px; border: 1px solid #dee2e6;">
            <h2 class="accordion-header">
              <button class="accordion-button fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#infoBasica" style="background: #f8f9fa; border-radius: 12px;">
                <i class="fas fa-store me-2" style="color: #0b4fa3;"></i>1. Informaci√≥n B√°sica
              </button>
            </h2>
            <div id="infoBasica" class="accordion-collapse collapse show" data-bs-parent="#guiaAccordion">
              <div class="accordion-body">
                <ul class="list-unstyled mb-0">
                  <li class="mb-2"><strong>Nombre:</strong> Escrib√≠ el nombre completo de tu negocio o lugar.</li>
                  <li class="mb-2"><strong>Categor√≠a:</strong> Seleccion√° la categor√≠a que mejor describe tu negocio.</li>
                  <li class="mb-2"><strong>Ubicaci√≥n:</strong> Escrib√≠ la direcci√≥n completa (calle, distrito, cant√≥n).</li>
                  <li class="mb-0"><strong>Descripci√≥n:</strong> Cont√° qu√© ofrece tu negocio, servicios, horarios especiales, etc.</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Fotos -->
          <div class="accordion-item mb-3" style="border-radius: 12px; border: 1px solid #dee2e6;">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#fotos" style="background: #f8f9fa; border-radius: 12px;">
                <i class="fas fa-images me-2" style="color: #0b4fa3;"></i>2. Fotos del Negocio (Hasta 10)
              </button>
            </h2>
            <div id="fotos" class="accordion-collapse collapse" data-bs-parent="#guiaAccordion">
              <div class="accordion-body">
                <p><strong>Pod√©s subir hasta 10 fotos de tu negocio:</strong></p>
                <ul class="mb-0">
                  <li>La primera foto ser√° la imagen principal que ver√°n los clientes</li>
                  <li>Seleccion√° fotos claras y de buena calidad</li>
                  <li>Mostr√° diferentes aspectos: fachada, interior, productos, servicios</li>
                  <li><strong>Tip:</strong> Presion√° Ctrl (o Cmd en Mac) y seleccion√° m√∫ltiples fotos a la vez</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Ubicaci√≥n -->
          <div class="accordion-item mb-3" style="border-radius: 12px; border: 1px solid #dee2e6;">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#ubicacion" style="background: #f8f9fa; border-radius: 12px;">
                <i class="fas fa-map-marker-alt me-2" style="color: #0b4fa3;"></i>3. Ubicaci√≥n en el Mapa
              </button>
            </h2>
            <div id="ubicacion" class="accordion-collapse collapse" data-bs-parent="#guiaAccordion">
              <div class="accordion-body">
                <p><strong>Marc√° la ubicaci√≥n exacta de tu negocio:</strong></p>
                <ul class="mb-0">
                  <li>Hac√© clic en el mapa donde est√° tu negocio</li>
                  <li>El pin se colocar√° autom√°ticamente</li>
                  <li>No necesit√°s saber coordenadas, solo tocar el mapa</li>
                  <li>Pod√©s mover el pin arrastr√°ndolo si te equivocaste</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Contacto -->
          <div class="accordion-item mb-3" style="border-radius: 12px; border: 1px solid #dee2e6;">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#contacto" style="background: #f8f9fa; border-radius: 12px;">
                <i class="fas fa-phone me-2" style="color: #0b4fa3;"></i>4. Informaci√≥n de Contacto
              </button>
            </h2>
            <div id="contacto" class="accordion-collapse collapse" data-bs-parent="#guiaAccordion">
              <div class="accordion-body">
                <ul class="mb-0">
                  <li><strong>Tel√©fono:</strong> N√∫mero de tel√©fono fijo (opcional)</li>
                  <li><strong>WhatsApp:</strong> N√∫mero con c√≥digo de pa√≠s (ej: 50612345678) - permite que los clientes te contacten directamente</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Horarios -->
          <div class="accordion-item mb-3" style="border-radius: 12px; border: 1px solid #dee2e6;">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#horarios" style="background: #f8f9fa; border-radius: 12px;">
                <i class="fas fa-clock me-2" style="color: #0b4fa3;"></i>5. Horarios de Atenci√≥n
              </button>
            </h2>
            <div id="horarios" class="accordion-collapse collapse" data-bs-parent="#guiaAccordion">
              <div class="accordion-body">
                <ul class="mb-0">
                  <li><strong>Abierto 24 horas:</strong> Marc√° esta opci√≥n si tu negocio est√° abierto todo el d√≠a</li>
                  <li><strong>Horario personalizado:</strong> Marc√° los d√≠as que abr√≠s y especific√° las horas de apertura y cierre</li>
                  <li>Ejemplo: Lunes a Viernes de 8:00 AM a 6:00 PM, S√°bados de 9:00 AM a 1:00 PM</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Tags -->
          <div class="accordion-item mb-3" style="border-radius: 12px; border: 1px solid #dee2e6;">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#tags" style="background: #f8f9fa; border-radius: 12px;">
                <i class="fas fa-tags me-2" style="color: #0b4fa3;"></i>6. Productos / Servicios (Tags)
              </button>
            </h2>
            <div id="tags" class="accordion-collapse collapse" data-bs-parent="#guiaAccordion">
              <div class="accordion-body">
                <p><strong>Agreg√° palabras clave sobre lo que ofrec√©s:</strong></p>
                <ul class="mb-0">
                  <li>Separ√° cada producto o servicio con comas</li>
                  <li>Ejemplo: "hamburguesa, papas fritas, refrescos, delivery"</li>
                  <li>Esto ayuda a que los clientes te encuentren cuando busquen estos productos</li>
                  <li>Pod√©s agregar o quitar tags despu√©s de crearlos</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Aprobaci√≥n -->
          <div class="accordion-item" style="border-radius: 12px; border: 1px solid #dee2e6;">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#aprobacion" style="background: #f8f9fa; border-radius: 12px;">
                <i class="fas fa-check-circle me-2" style="color: #38b24d;"></i>7. Aprobaci√≥n
              </button>
            </h2>
            <div id="aprobacion" class="accordion-collapse collapse" data-bs-parent="#guiaAccordion">
              <div class="accordion-body">
                <p><strong>Despu√©s de enviar el formulario:</strong></p>
                <ul class="mb-0">
                  <li>Tu negocio quedar√° en estado <strong>"pendiente"</strong></li>
                  <li>Un administrador revisar√° la informaci√≥n</li>
                  <li>Cuando sea aprobado, aparecer√° p√∫blicamente en el sitio</li>
                  <li>Te notificaremos cuando sea aprobado</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-info mt-4 mb-0" style="background: #e8f0f8; border-color: #0b4fa3; border-radius: 12px;">
          <i class="fas fa-lightbulb me-2" style="color: #0b4fa3;"></i>
          <strong>Tip:</strong> Cuanta m√°s informaci√≥n proporcion√©s, m√°s f√°cil ser√° para los clientes encontrarte y contactarte.
        </div>
      </div>
      <div class="modal-footer" style="border-top: 1px solid #dee2e6; border-radius: 0 0 18px 18px;">
        <button type="button" class="btn btn-primary fw-bold" data-bs-dismiss="modal" style="border-radius: 8px;">
          <i class="fas fa-check me-2"></i>Entendido
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Funciones para cargar cantones y distritos din√°micamente
  function cargarCantones() {
    const provinciaSelect = document.getElementById('provincia');
    const cantonSelect = document.getElementById('canton');
    const distritoSelect = document.getElementById('distrito');
    
    const provincia = provinciaSelect.value;
    
    if (!provincia) {
      cantonSelect.innerHTML = '<option value="">Primero seleccion√° una provincia</option>';
      cantonSelect.disabled = true;
      distritoSelect.innerHTML = '<option value="">Primero seleccion√° un cant√≥n</option>';
      distritoSelect.disabled = true;
      return;
    }
    
    // Cargar cantones desde la API
    fetch(`/api/ubicaciones/cantones?provincia=${encodeURIComponent(provincia)}`)
      .then(response => response.json())
      .then(data => {
        cantonSelect.innerHTML = '<option value="">Seleccionar cant√≥n</option>';
        if (data.cantones && data.cantones.length > 0) {
          data.cantones.forEach(canton => {
            const option = document.createElement('option');
            option.value = canton;
            option.textContent = canton;
            cantonSelect.appendChild(option);
          });
          cantonSelect.disabled = false;
        } else {
          cantonSelect.innerHTML = '<option value="">No hay cantones disponibles</option>';
          cantonSelect.disabled = true;
        }
        
        // Limpiar distritos
        distritoSelect.innerHTML = '<option value="">Primero seleccion√° un cant√≥n</option>';
        distritoSelect.disabled = true;
      })
      .catch(error => {
        console.error('Error al cargar cantones:', error);
        cantonSelect.innerHTML = '<option value="">Error al cargar cantones</option>';
        cantonSelect.disabled = true;
      });
  }
  
  function cargarDistritos() {
    const provinciaSelect = document.getElementById('provincia');
    const cantonSelect = document.getElementById('canton');
    const distritoSelect = document.getElementById('distrito');
    
    const provincia = provinciaSelect.value;
    const canton = cantonSelect.value;
    
    if (!provincia || !canton) {
      distritoSelect.innerHTML = '<option value="">Primero seleccion√° un cant√≥n</option>';
      distritoSelect.disabled = true;
      return;
    }
    
    // Cargar distritos desde la API
    fetch(`/api/ubicaciones/distritos?provincia=${encodeURIComponent(provincia)}&canton=${encodeURIComponent(canton)}`)
      .then(response => response.json())
      .then(data => {
        distritoSelect.innerHTML = '<option value="">Seleccionar distrito</option>';
        if (data.distritos && data.distritos.length > 0) {
          data.distritos.forEach(distrito => {
            const option = document.createElement('option');
            option.value = distrito;
            option.textContent = distrito;
            distritoSelect.appendChild(option);
          });
          distritoSelect.disabled = false;
        } else {
          distritoSelect.innerHTML = '<option value="">No hay distritos disponibles</option>';
          distritoSelect.disabled = true;
        }
      })
      .catch(error => {
        console.error('Error al cargar distritos:', error);
        distritoSelect.innerHTML = '<option value="">Error al cargar distritos</option>';
        distritoSelect.disabled = true;
      });
  }
</script>

</body>
</html>

