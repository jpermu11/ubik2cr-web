<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Negocios | Ubik2CR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        #map { 
            height: calc(100vh - 70px); 
            width: 100%; 
            margin-top: 70px;
        }
        
        @media (max-width: 768px) {
            #map {
                height: calc(100vh - 56px);
                margin-top: 56px;
            }
        }

        /* Bot√≥n flotante para cerrar/volver */
        .btn-close-map {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background-color: white;
            padding: 12px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            text-decoration: none;
            color: #333;
            font-weight: bold;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            transition: all 0.2s;
        }
        .btn-close-map:hover { background-color: #f8f9fa; color: #ff6b6b; transform: scale(1.05); }
        .btn-close-map:active { transform: scale(0.95); }

        /* Bot√≥n flotante para "Mi Ubicaci√≥n" */
        .btn-locate {
            position: absolute;
            bottom: 30px;
            right: 20px;
            z-index: 1000;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            min-width: 56px;
            min-height: 56px;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            touch-action: manipulation;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-locate:hover { background-color: #27ae60; transform: scale(1.1); }
        .btn-locate:active { transform: scale(0.95); }
        
        @media (max-width: 768px) {
            #map {
                height: calc(100vh - 56px);
                margin-top: 56px;
            }
            nav {
                padding: 10px 12px;
                height: 56px;
            }
            nav img {
                height: 28px !important;
            }
            nav span {
                font-size: 1rem !important;
            }
            .btn-close-map {
                padding: 8px 14px;
                font-size: 13px;
                min-height: 36px;
            }
            .btn-locate {
                bottom: 20px;
                right: 15px;
                width: 50px;
                height: 50px;
                min-width: 50px;
                min-height: 50px;
            }
        }
    </style>
</head>
<body>

<!-- Navbar simple para el mapa -->
<nav style="position: fixed; top: 0; left: 0; right: 0; z-index: 1001; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; height: 70px;">
    <a href="/" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: #0b4fa3; font-weight: 700; font-size: 1.125rem;">
        <img src="{{ url_for('static', filename='uploads/logo.png') }}" alt="Ubik2CR" style="height: 32px; width: auto;">
        <span class="d-none d-sm-inline">Ubik2CR</span>
    </a>
    <a href="/" class="btn-close-map" style="position: static; top: auto; right: auto; transform: none; margin: 0;">‚úñ Cerrar</a>
</nav>

<div id="map"></div>

<button class="btn-locate" onclick="ubicarUsuario()" title="Ver qu√© hay cerca de m√≠">üìç</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- 1. EL FIX DEL √çCONO ROTO (Esto es lo que faltaba) ---
    delete L.Icon.Default.prototype._getIconUrl;
    L.Icon.Default.mergeOptions({
        iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    });
    // ---------------------------------------------------------

    // 2. Cargar los negocios desde la base de datos (Python los inyecta aqu√≠)
    var negocios = [
        {% for n in negocios %}
        {% if n.latitud is not none and n.longitud is not none %}
        {
            nombre: "{{ n.nombre|e }}",
            lat: {{ n.latitud }},
            lon: {{ n.longitud }},
            cat: "{{ n.categoria|e }}",
            ubicacion: "{{ n.ubicacion|e if n.ubicacion else '' }}",
            id: {{ n.id }},
            es_vip: {{ 'true' if n.es_vip else 'false' }}
        },
        {% endif %}
        {% endfor %}
    ];

    // 3. Iniciar Mapa (Centrado en Costa Rica o en los negocios si hay)
    var map;
    var markersGroup = L.layerGroup();
    
    if (negocios.length > 0 && negocios[0].lat && negocios[0].lon) {
        // Si hay negocios, centrar en ellos
        var bounds = L.latLngBounds([]);
        negocios.forEach(function(n) {
            if (n.lat && n.lon) {
                bounds.extend([n.lat, n.lon]);
            }
        });
        
        // Iniciar mapa ajustado a los negocios
        map = L.map('map').fitBounds(bounds, { padding: [50, 50], maxZoom: 15 });
    } else {
        // Si no hay negocios, centrar en Costa Rica
        map = L.map('map').setView([10.0, -84.0], 8);
    }

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    // 4. Poner los pines en el mapa con mejor dise√±o
    if (negocios.length > 0) {
        negocios.forEach(function(n) {
            if (n.lat && n.lon && !isNaN(n.lat) && !isNaN(n.lon)) {
                // Crear √≠cono personalizado
                var iconColor = n.es_vip ? '#FFB800' : '#0b4fa3';
                var iconHtml = `<div style="background-color: ${iconColor}; width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;">
                    <span style="transform: rotate(45deg); color: white; font-size: 18px;">üìç</span>
                </div>`;
                
                var customIcon = L.divIcon({
                    html: iconHtml,
                    className: 'custom-marker',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32]
                });
                
                var marker = L.marker([n.lat, n.lon], { icon: customIcon })
                    .addTo(markersGroup);
                
                // Popup mejorado
                var popupContent = `
                    <div style="min-width: 200px; padding: 8px;">
                        <div style="margin-bottom: 8px;">
                            <strong style="font-size: 1.1rem; color: #0b4fa3; display: block; margin-bottom: 4px;">${n.nombre}</strong>
                            ${n.ubicacion ? `<small style="color: #666; display: block; margin-bottom: 6px;">üìç ${n.ubicacion}</small>` : ''}
                            <span style="display: inline-block; background: #e8f0f8; color: #0b4fa3; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">${n.cat}</span>
                            ${n.es_vip ? '<span style="display: inline-block; background: #FFB800; color: #000; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 700; margin-left: 6px;">‚≠ê VIP</span>' : ''}
                        </div>
                        <a href="/negocio/${n.id}" style="display: inline-block; background: linear-gradient(135deg, #0b4fa3, #083d7d); color: white; text-decoration: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; margin-top: 8px; transition: transform 0.2s;" 
                           onmouseover="this.style.transform='scale(1.05)'" 
                           onmouseout="this.style.transform='scale(1)'">
                            Ver Detalles ‚Üí
                        </a>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
            }
        });
        
        markersGroup.addTo(map);
        
        // Si hab√≠a negocios pero el ajuste no funcion√≥ bien, hacer ajuste manual
        setTimeout(function() {
            if (markersGroup.getLayers().length > 0) {
                var group = new L.featureGroup(markersGroup.getLayers());
                map.fitBounds(group.getBounds().pad(0.1), { maxZoom: 15 });
            }
        }, 100);
    } else {
        // Mostrar mensaje si no hay negocios
        map.setView([10.0, -84.0], 8);
        L.marker([10.0, -84.0]).addTo(map).bindPopup('No hay negocios registrados a√∫n');
    }

    // 5. Funci√≥n para ubicar al usuario (Bot√≥n verde)
    var userCircle = null;
    var userMarker = null;
    
    function ubicarUsuario() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;

                // Remover marcador anterior si existe
                if (userCircle) map.removeLayer(userCircle);
                if (userMarker) map.removeLayer(userMarker);

                // Mover mapa al usuario con zoom apropiado
                map.setView([lat, lng], 13);

                // Poner un c√≠rculo azul donde est√° el usuario
                userCircle = L.circle([lat, lng], {
                    color: '#0b4fa3',
                    fillColor: '#0b4fa3',
                    fillOpacity: 0.15,
                    radius: 800
                }).addTo(map);

                // Marcador de usuario
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: '<div style="background-color: #0b4fa3; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                        className: 'user-location-marker',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map).bindPopup("<strong>Tu ubicaci√≥n</strong><br>Negocios cercanos en un radio de 800m").openPopup();

            }, function(error) {
                var msg = "No pudimos detectar tu ubicaci√≥n. ";
                if (error.code === error.PERMISSION_DENIED) {
                    msg += "Por favor, permite el acceso a tu ubicaci√≥n en la configuraci√≥n del navegador.";
                } else if (error.code === error.POSITION_UNAVAILABLE) {
                    msg += "La informaci√≥n de ubicaci√≥n no est√° disponible.";
                } else {
                    msg += "Revisa que el GPS est√© activo.";
                }
                alert(msg);
            }, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        } else {
            alert("Tu navegador no soporta geolocalizaci√≥n.");
        }
    }
</script>

</body>
</html>

