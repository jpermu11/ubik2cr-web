<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Editar negocio | Ubik2CR</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Leaflet (mapa con pin) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body { background:#f5f7fa; }
    .topbar{
      background: linear-gradient(90deg,#0b4fa3,#38b24d);
      color:#fff;
    }
    .brand img{ height:56px; }
    .brand span{ font-weight:800; letter-spacing:.2px; }
    .cardx{
      border:none; border-radius:16px;
      box-shadow:0 10px 25px rgba(0,0,0,.08);
      overflow:hidden;
    }
    .cardx-header{
      background: rgba(11,79,163,.08);
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    #map{
      height: 360px;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.10);
    }
    .hint{
      font-size:.92rem;
      color:#6c757d;
    }
    .badge-soft{
      background: rgba(56,178,77,.12);
      color:#1e7e34;
      border:1px solid rgba(56,178,77,.25);
      font-weight:700;
    }
  </style>
</head>

<body>

<!-- HEADER -->
<nav class="navbar topbar">
  <div class="container d-flex align-items-center justify-content-between py-2">
    <a class="navbar-brand brand d-flex align-items-center gap-2 text-white text-decoration-none" href="/">
      <img src="{{ url_for('static', filename='uploads/logo.png') }}" alt="Ubik2CR">
      <span class="fs-4">Ubik2CR</span>
    </a>

    <div class="d-flex gap-2">
      <a href="/admin/comercios" class="btn btn-light fw-bold">
        <i class="fa-solid fa-store me-1"></i> Comercios
      </a>
      <a href="/admin" class="btn btn-outline-light">
        <i class="fa-solid fa-gauge me-1"></i> Panel
      </a>
    </div>
  </div>
</nav>

<div class="container my-4">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="fw-bold mb-1">Editar negocio</h2>
      <div class="hint">
        Estado actual:
        <span class="badge badge-soft">{{ n.estado }}</span>
        &nbsp;â€¢&nbsp; Al guardar, quedarÃ¡ <b>pendiente</b> para revisiÃ³n del admin.
      </div>
    </div>
    <a href="/admin/comercios" class="btn btn-outline-secondary">
      <i class="fa-solid fa-arrow-left me-1"></i> Volver
    </a>
  </div>

  <div class="cardx">
    <div class="cardx-header p-3">
      <div class="fw-bold">
        <i class="fa-solid fa-pen-to-square me-2"></i> InformaciÃ³n del negocio
      </div>
      <div class="hint">Tip: tocÃ¡ el mapa para colocar el pin (mÃ¡s fÃ¡cil que lat/long).</div>
    </div>

    <div class="p-4">
      <form method="POST" enctype="multipart/form-data">

        <div class="row g-3">
          <div class="col-md-8">
            <label class="form-label fw-bold">Nombre</label>
            <input type="text" name="nombre" class="form-control form-control-lg" value="{{ n.nombre }}" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">CategorÃ­a</label>
            <select name="categoria" class="form-select form-select-lg" required>
              
              <optgroup label="ğŸ½ï¸ Comida y Bebidas">
                <option value="Sodas y Rest." {% if n.categoria=='Sodas y Rest.' %}selected{% endif %}>ğŸ´ Sodas y Rest.</option>
                <option value="Comida RÃ¡pida" {% if n.categoria=='Comida RÃ¡pida' %}selected{% endif %}>ğŸ• Comida RÃ¡pida</option>
                <option value="CafeterÃ­as" {% if n.categoria=='CafeterÃ­as' %}selected{% endif %}>â˜• CafeterÃ­as</option>
                <option value="Bares y Licores" {% if n.categoria=='Bares y Licores' %}selected{% endif %}>ğŸº Bares y Licores</option>
                <option value="HeladerÃ­as" {% if n.categoria=='HeladerÃ­as' %}selected{% endif %}>ğŸ¦ HeladerÃ­as</option>
                <option value="Restaurante" {% if n.categoria=='Restaurante' %}selected{% endif %}>ğŸ” Restaurantes</option>
              </optgroup>
              
              <optgroup label="ğŸ›’ Alimentos">
                <option value="VerdurerÃ­as" {% if n.categoria=='VerdurerÃ­as' %}selected{% endif %}>ğŸ¥¬ VerdurerÃ­as</option>
                <option value="CarnicerÃ­as" {% if n.categoria=='CarnicerÃ­as' %}selected{% endif %}>ğŸ¥© CarnicerÃ­as</option>
                <option value="PanaderÃ­as" {% if n.categoria=='PanaderÃ­as' %}selected{% endif %}>ğŸ¥ PanaderÃ­as</option>
                <option value="Super y Pulpes" {% if n.categoria=='Super y Pulpes' %}selected{% endif %}>ğŸ›’ Super y Pulpes</option>
              </optgroup>
              
              <optgroup label="ğŸ¥ Salud">
                <option value="Farmacias" {% if n.categoria=='Farmacias' %}selected{% endif %}>ğŸ’Š Farmacias</option>
                <option value="ClÃ­nicas y Dr." {% if n.categoria=='ClÃ­nicas y Dr.' %}selected{% endif %}>ğŸ©º ClÃ­nicas y Dr.</option>
                <option value="Dentistas" {% if n.categoria=='Dentistas' %}selected{% endif %}>ğŸ¦· Dentistas</option>
                <option value="Laboratorios" {% if n.categoria=='Laboratorios' %}selected{% endif %}>ğŸ§ª Laboratorios</option>
                <option value="Veterinarias" {% if n.categoria=='Veterinarias' %}selected{% endif %}>ğŸ¾ Veterinarias</option>
                <option value="Ã“pticas" {% if n.categoria=='Ã“pticas' %}selected{% endif %}>ğŸ‘“ Ã“pticas</option>
                <option value="CCSS" {% if n.categoria=='CCSS' %}selected{% endif %}>ğŸ¥ CCSS / ClÃ­nica / EbÃ¡is</option>
              </optgroup>
              
              <optgroup label="ğŸ’… Belleza y Fitness">
                <option value="Gimnasios" {% if n.categoria=='Gimnasios' %}selected{% endif %}>ğŸ’ª Gimnasios</option>
                <option value="Spas y Masajes" {% if n.categoria=='Spas y Masajes' %}selected{% endif %}>ğŸ§˜ Spas y Masajes</option>
                <option value="Belleza y BarberÃ­a" {% if n.categoria=='Belleza y BarberÃ­a' %}selected{% endif %}>âœ‚ï¸ Belleza y BarberÃ­a</option>
              </optgroup>
              
              <optgroup label="ğŸ‘• Ropa y TecnologÃ­a">
                <option value="Ropa y Calzado" {% if n.categoria=='Ropa y Calzado' %}selected{% endif %}>ğŸ‘— Ropa y Calzado</option>
                <option value="TecnologÃ­a y Cel." {% if n.categoria=='TecnologÃ­a y Cel.' %}selected{% endif %}>ğŸ“± TecnologÃ­a y Cel.</option>
                <option value="Reparaciones Tech" {% if n.categoria=='Reparaciones Tech' %}selected{% endif %}>ğŸ’» Reparaciones Tech</option>
              </optgroup>
              
              <optgroup label="ğŸ”§ ConstrucciÃ³n y Automotriz">
                <option value="FerreterÃ­as" {% if n.categoria=='FerreterÃ­as' %}selected{% endif %}>ğŸ”¨ FerreterÃ­as</option>
                <option value="Materiales ConstrucciÃ³n" {% if n.categoria=='Materiales ConstrucciÃ³n' %}selected{% endif %}>ğŸ§± Materiales ConstrucciÃ³n</option>
                <option value="MecÃ¡nica y Llantas" {% if n.categoria=='MecÃ¡nica y Llantas' %}selected{% endif %}>ğŸ”§ MecÃ¡nica y Llantas</option>
                <option value="Transporte" {% if n.categoria=='Transporte' %}selected{% endif %}>ğŸš• Transporte</option>
                <option value="Gasolineras" {% if n.categoria=='Gasolineras' %}selected{% endif %}>â›½ Gasolineras</option>
                <option value="Automotriz" {% if n.categoria=='Automotriz' %}selected{% endif %}>ğŸš— Automotriz</option>
              </optgroup>
              
              <optgroup label="ğŸ“š EducaciÃ³n y Cultura">
                <option value="LibrerÃ­as y Bazar" {% if n.categoria=='LibrerÃ­as y Bazar' %}selected{% endif %}>ğŸ“– LibrerÃ­as y Bazar</option>
                <option value="Escuelas" {% if n.categoria=='Escuelas' %}selected{% endif %}>ğŸ« Escuelas</option>
                <option value="Bibliotecas" {% if n.categoria=='Bibliotecas' %}selected{% endif %}>ğŸ“š Bibliotecas</option>
                <option value="Academias" {% if n.categoria=='Academias' %}selected{% endif %}>ğŸ“ Academias</option>
                <option value="Educacion" {% if n.categoria=='Educacion' %}selected{% endif %}>ğŸ“ EducaciÃ³n</option>
              </optgroup>
              
              <optgroup label="ğŸ¨ Turismo y Entretenimiento">
                <option value="Hoteles y Hospedaje" {% if n.categoria=='Hoteles y Hospedaje' %}selected{% endif %}>ğŸ¨ Hoteles y Hospedaje</option>
                <option value="Parques" {% if n.categoria=='Parques' %}selected{% endif %}>ğŸŒ³ Parques</option>
                <option value="Plazas" {% if n.categoria=='Plazas' %}selected{% endif %}>ğŸï¸ Plazas</option>
                <option value="Polideportivo" {% if n.categoria=='Polideportivo' %}selected{% endif %}>ğŸŸï¸ Polideportivos</option>
                <option value="Cines y Entretenimiento" {% if n.categoria=='Cines y Entretenimiento' %}selected{% endif %}>ğŸ¬ Cines y Entretenimiento</option>
                <option value="Turismo" {% if n.categoria=='Turismo' %}selected{% endif %}>ğŸ—ºï¸ Turismo</option>
              </optgroup>
              
              <optgroup label="ğŸ’° Finanzas">
                <option value="Bancos" {% if n.categoria=='Bancos' %}selected{% endif %}>ğŸ¦ Bancos</option>
                <option value="Cooperativas" {% if n.categoria=='Cooperativas' %}selected{% endif %}>ğŸ’µ Cooperativas</option>
              </optgroup>
              
              <optgroup label="ğŸ›ï¸ Servicios PÃºblicos">
                <option value="Cruz Roja" {% if n.categoria=='Cruz Roja' %}selected{% endif %}>ğŸš‘ Cruz Roja</option>
                <option value="Bomberos" {% if n.categoria=='Bomberos' %}selected{% endif %}>ğŸš’ Bomberos</option>
                <option value="PolicÃ­a" {% if n.categoria=='PolicÃ­a' %}selected{% endif %}>ğŸš“ PolicÃ­a</option>
                <option value="Municipalidad" {% if n.categoria=='Municipalidad' %}selected{% endif %}>ğŸ›ï¸ Municipalidad</option>
                <option value="Iglesia" {% if n.categoria=='Iglesia' %}selected{% endif %}>â›ª Iglesias</option>
                <option value="Instituciones PÃºblicas" {% if n.categoria=='Instituciones PÃºblicas' %}selected{% endif %}>ğŸ¢ Instituciones PÃºblicas</option>
                <option value="Edificio Gubernamental" {% if n.categoria=='Edificio Gubernamental' %}selected{% endif %}>ğŸ¢ Edificio Gubernamental</option>
              </optgroup>
              
              <optgroup label="ğŸ’¼ Servicios Profesionales">
                <option value="Servicios Pro" {% if n.categoria=='Servicios Pro' %}selected{% endif %}>ğŸ’¼ Servicios Pro</option>
                <option value="ConsultorÃ­a" {% if n.categoria=='ConsultorÃ­a' %}selected{% endif %}>ğŸ“Š ConsultorÃ­a</option>
                <option value="Abogados" {% if n.categoria=='Abogados' %}selected{% endif %}>âš–ï¸ Abogados</option>
                <option value="Contables" {% if n.categoria=='Contables' %}selected{% endif %}>ğŸ“‹ Contables</option>
                <option value="Salones de Eventos" {% if n.categoria=='Salones de Eventos' %}selected{% endif %}>ğŸ‰ Salones de Eventos</option>
                <option value="Mudanzas y Transporte" {% if n.categoria=='Mudanzas y Transporte' %}selected{% endif %}>ğŸšš Mudanzas y Transporte</option>
                <option value="PlomerÃ­a y Electricidad" {% if n.categoria=='PlomerÃ­a y Electricidad' %}selected{% endif %}>âš¡ PlomerÃ­a y Electricidad</option>
                <option value="JardinerÃ­a" {% if n.categoria=='JardinerÃ­a' %}selected{% endif %}>ğŸŒ± JardinerÃ­a</option>
                <option value="Mascotas y Suministros" {% if n.categoria=='Mascotas y Suministros' %}selected{% endif %}>ğŸ• Mascotas y Suministros</option>
                <option value="Servicios" {% if n.categoria=='Servicios' %}selected{% endif %}>ğŸ§° Servicios</option>
              </optgroup>
              
              <optgroup label="ğŸª Otros">
                <option value="Comercio" {% if n.categoria=='Comercio' %}selected{% endif %}>ğŸª Comercios</option>
                <option value="Otros" {% if n.categoria=='Otros' %}selected{% endif %}>âœ¨ Otros</option>
              </optgroup>

            </select>
          </div>

          <div class="col-md-7">
            <label class="form-label fw-bold">UbicaciÃ³n (texto)</label>
            <input type="text" name="ubicacion" class="form-control" value="{{ n.ubicacion or '' }}" placeholder="Ej: Frente al parque, San Pedro de PoÃ¡s" required>
            <div class="hint mt-1">Esto es lo que verÃ¡ la gente. Ejemplo: "200m norte de la iglesia".</div>
          </div>

          <div class="col-md-5">
            <label class="form-label fw-bold">Link de Google Maps (opcional)</label>
            <input type="url" name="maps_url" class="form-control" value="{{ n.maps_url or '' }}" placeholder="https://maps.app.goo.gl/...">
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">TelÃ©fono (opcional)</label>
            <input type="text" name="telefono" class="form-control" value="{{ n.telefono or '' }}">
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">WhatsApp (opcional)</label>
            <input type="text" name="whatsapp" class="form-control" value="{{ n.whatsapp or '' }}" placeholder="Ej: +506 8xxx-xxxx">
          </div>

          <div class="col-12">
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="abierto_24h" name="abierto_24h" value="1"
                     {% if n.abierto_24h %}checked{% endif %} onchange="toggleHorarios()">
              <label class="form-check-label fw-bold" for="abierto_24h">Abierto 24 horas</label>
            </div>
          </div>

          <div class="col-12" id="horarios-container" {% if n.abierto_24h %}style="display:none;"{% endif %}>
            <label class="form-label fw-bold mb-3">Horario por dÃ­a (opcional)</label>
            <div class="row g-2">
              {% set dias = [
                ('lunes', 'Lunes'),
                ('martes', 'Martes'),
                ('miercoles', 'MiÃ©rcoles'),
                ('jueves', 'Jueves'),
                ('viernes', 'Viernes'),
                ('sabado', 'SÃ¡bado'),
                ('domingo', 'Domingo')
              ] %}
              {% set horario_dict = get_horario_dict(n.horario or '') %}
              {% for dia_key, dia_nombre in dias %}
              {% set dia_data = horario_dict.get(dia_key, {}) %}
              <div class="col-md-6 col-lg-4">
                <div class="card p-2" style="border: 1px solid #ddd; border-radius: 8px;">
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="horario_{{ dia_key }}_abierto" name="horario_{{ dia_key }}_abierto" value="1"
                           {% if dia_data.get('abierto') %}checked{% endif %} onchange="toggleDia('{{ dia_key }}')">
                    <label class="form-check-label fw-bold" for="horario_{{ dia_key }}_abierto">{{ dia_nombre }}</label>
                  </div>
                  <div id="horario_{{ dia_key }}_times" style="display:{% if dia_data.get('abierto') %}block{% else %}none{% endif %};">
                    <div class="row g-1">
                      <div class="col-6">
                        <input type="time" class="form-control form-control-sm" name="horario_{{ dia_key }}_apertura" 
                               value="{{ dia_data.get('apertura', '') }}" placeholder="Apertura">
                      </div>
                      <div class="col-6">
                        <input type="time" class="form-control form-control-sm" name="horario_{{ dia_key }}_cierre" 
                               value="{{ dia_data.get('cierre', '') }}" placeholder="Cierre">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            <div class="hint mt-2">MarcÃ¡ los dÃ­as que estÃ¡ abierto y especificÃ¡ las horas de apertura y cierre.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Foto / Logo (opcional)</label>
            <input type="file" name="foto" class="form-control">
          </div>

          <div class="col-12">
            <label class="form-label fw-bold">DescripciÃ³n</label>
            <textarea name="descripcion" class="form-control" rows="4" required>{{ n.descripcion or '' }}</textarea>
          </div>
        </div>

        <hr class="my-4">

        <!-- MAPA -->
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="fw-bold">
            <i class="fa-solid fa-map-location-dot me-2"></i> UbicaciÃ³n en el mapa
          </div>
          <div class="hint">TocÃ¡ el mapa para colocar el pin âœ…</div>
        </div>

        <div id="map"></div>

        <!-- hidden lat/long (se llenan con el pin) -->
        <input type="hidden" id="latitud" name="latitud" value="{{ n.latitud if n.latitud is not none else '' }}">
        <input type="hidden" id="longitud" name="longitud" value="{{ n.longitud if n.longitud is not none else '' }}">

        <div class="hint mt-2">
          Si el usuario no sabe de coordenadas, no pasa nada: solo toca el mapa y listo.
        </div>

        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-success btn-lg fw-bold">
            <i class="fa-solid fa-floppy-disk me-2"></i> Guardar cambios
          </button>
          <a href="/admin/comercios" class="btn btn-outline-secondary btn-lg">
            Cancelar
          </a>
        </div>

      </form>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // Centro por defecto (Costa Rica)
  const defaultLat = 9.9281;
  const defaultLng = -84.0907;

  const latInput = document.getElementById("latitud");
  const lngInput = document.getElementById("longitud");

  const existingLat = parseFloat(latInput.value);
  const existingLng = parseFloat(lngInput.value);

  const startLat = Number.isFinite(existingLat) ? existingLat : defaultLat;
  const startLng = Number.isFinite(existingLng) ? existingLng : defaultLng;

  const map = L.map('map').setView([startLat, startLng], Number.isFinite(existingLat) ? 16 : 12);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let marker = null;

  function setMarker(lat, lng){
    if(marker) map.removeLayer(marker);
    marker = L.marker([lat, lng]).addTo(map);
    latInput.value = lat.toFixed(6);
    lngInput.value = lng.toFixed(6);
  }

  // Si ya hay coordenadas, mostrar marker
  if(Number.isFinite(existingLat) && Number.isFinite(existingLng)){
    setMarker(existingLat, existingLng);
  }

  // Click para poner pin
  map.on('click', function(e){
    setMarker(e.latlng.lat, e.latlng.lng);
  });

  function toggleHorarios() {
    const abierto24h = document.getElementById('abierto_24h');
    const container = document.getElementById('horarios-container');
    if (!abierto24h || !container) return;
    
    if (abierto24h.checked) {
      container.style.display = 'none';
      // Desmarcar todos los dÃ­as
      document.querySelectorAll('[id^="horario_"][id$="_abierto"]').forEach(cb => {
        cb.checked = false;
        const diaKey = cb.id.replace('horario_', '').replace('_abierto', '');
        const timesDiv = document.getElementById(`horario_${diaKey}_times`);
        if (timesDiv) {
          timesDiv.style.display = 'none';
        }
      });
    } else {
      container.style.display = 'block';
    }
  }

  function toggleDia(diaKey) {
    const checkbox = document.getElementById(`horario_${diaKey}_abierto`);
    const timesDiv = document.getElementById(`horario_${diaKey}_times`);
    if (checkbox && timesDiv) {
      if (checkbox.checked) {
        timesDiv.style.display = 'block';
      } else {
        timesDiv.style.display = 'none';
        // Limpiar los campos de hora
        const apertura = timesDiv.querySelector(`input[name="horario_${diaKey}_apertura"]`);
        const cierre = timesDiv.querySelector(`input[name="horario_${diaKey}_cierre"]`);
        if (apertura) apertura.value = '';
        if (cierre) cierre.value = '';
      }
    }
  }

  // Inicializar
  const chk24 = document.getElementById('abierto_24h');
  if (chk24) {
    chk24.addEventListener('change', toggleHorarios);
    toggleHorarios(); // Ejecutar al cargar
  }
</script>

</body>
</html>

